package dao;

import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.ArrayList;

import config.DBConfig;
import jdbc.exception.DuplicateIdException;
import jdbc.vo.Member;
import vo.Student;

public class StudentDAO {
	// ---------------------------------- for singleton  ----------------------------------//
	private static StudentDAO dao = new StudentDAO();
	private StudentDAO() {
		// do nothing 
	}
	public static StudentDAO getInstance() {
		return dao;
	}
	// ---------------------------------- for connection ----------------------------------//
	public Connection connection() {
		Connection conn = null;
		try {
			conn = 
				DriverManager.getConnection(DBConfig.URL, DBConfig.USER, DBConfig.PASSWORD);
				// System.out.println("DB Connnected!");
		} catch (SQLException e) {
			System.out.println("DB Disconnected !");
		}
	
		return conn;
	}
	// ---------------------------------- for close ----------------------------------//
	public void closeAll(PreparedStatement ps, Connection conn) throws SQLException {
		ps.close();
		conn.close();
	}
	public void closeAll(PreparedStatement ps, Connection conn, ResultSet rs) throws SQLException {
		rs.close();
		closeAll(ps, conn);
	}



	// ---------------------------------- for SELECT  ----------------------------------//
		public ArrayList<Student> getAllStudent() throws SQLException{
			ArrayList<Student> result = null;
			Connection conn = connection();
			PreparedStatement ps = 
					conn.prepareStatement("SELECT * FROM member");
			
			ResultSet rs = ps.executeQuery();
			
			while(rs.next()) {
				result.add(new Student(rs.getInt("classno"), rs.getString("sid"), rs.getString("password")));
			}
				
			return result;
		}
	
		// ---------------------------------- for INSERT ---------------------------------- //
		public void addMember(Student student) throws SQLException, DuplicateIdException {
			Connection conn = null;
			PreparedStatement ps = null;
			
			try {
				conn = connection();
				if( !doesExist(member.getId(), conn) ){
					conn = connection();
					ps = conn.prepareStatement("INSERT INTO member VALUES(?,?,?,?)");
					
					ps.setString(1, member.getId());
					ps.setString(2, member.getName());
					ps.setString(3, member.getPassword());
					ps.setString(4, member.getAddress());
					
					ps.executeUpdate();
				} else throw new DuplicateIdException("Already Existing ID !");
			} finally {
				closeAll(ps, conn);
			}
			
		}
		

	// ---------------------------------- for Search ---------------------------------- //
	public boolean doesExist(String id, Connection conn) throws SQLException {
		//Connection conn = connection();
		PreparedStatement ps = 
				conn.prepareStatement("SELECT sid FROM student"
									+ "WHERE sid = ?");
		ps.setString(1, id);
		ResultSet rs = ps.executeQuery();

		return rs.next();
	}
	
	
}
